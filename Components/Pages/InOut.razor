@attribute [Route(Routes.InOut)]
@using Eggbox.Models
@using Eggbox.Services
@using Color = Eggbox.Models.Color
@using Eggbox.Helpers
@using Optional
@using Icon = Eggbox.Models.Icon
@using Eggbox.Extensions
@inject Mixer Mixer
@inject MixerModel Model
@inject NavigationManager Nav

<div class="h-full flex flex-col select-none p-4">
    <section class="flex flex-col items-center mb-4">
        <div class="relative p-4 rounded-xl border bg-gray-50 border-gray-200
            dark:bg-gray-900 dark:border-gray-700">
            <!-- INPUTS -->
            <div class="grid grid-cols-8 gap-1.5 w-full">
                @foreach (var ch in Model.Channels)
                {
                    var isActive = SelectedInput?.Index == ch.Index;

                    <div class="relative">
                        <span class="text-[6px] font-medium absolute -left-1 -top-1">@ch.Index</span>
                        <div class="size-8 rounded-full border flex items-center justify-center cursor-pointer transition text-gray-950 border-gray-300 dark:border-gray-700 shadow-[1px_2px_#00000021_inset]
                         @(isActive ? "border-primary-500 ring-2 ring-primary-500/50" : "")"
                             style="background-color:@(ch.Color.Match(c => c.HexOpaque, () => "#cbcbcb"))"
                             @onclick="() => SelectInput(ch)">
                            @ch.Icon.Render(icon => @<i class="@icon.ToString() fal text-base"></i>)
                            
                        </div>
                    </div>
                }
            </div>

            <!-- OUTPUTS -->
            <div class="grid grid-cols-8 gap-1.5 mt-3 justify-center">
                @foreach (var bus in Model.Busses)
                {
                    var isActive = SelectedOutput?.Index == bus.Index;

                    <div class="relative">
                        <div class="size-8 rounded-tl-lg rounded-tr-4xl rounded-b-4xl border flex items-center justify-center cursor-pointer transition text-gray-900
                            border-gray-300 dark:border-gray-600 shadow-[1px_2px_#00000021_inset]
                            @(isActive ? "border-primary-500 ring-2 ring-primary-500/50" : "")"
                             style="background-color:@bus.Color.HexOpaque"
                             @onclick="() => SelectOutput(bus.Index)">
                            <i class="fal fa-headphones text-xs"></i>
                        </div>
                        <div class="absolute text-[6px] text-gray-500 mt-0.5 w-full text-center">@bus.Name</div>
                    </div>
                }

                <div class="flex items-center justify-center">
                    <div class="size-6 rounded-full bg-gray-300 dark:bg-gray-600 relative">
                        <div class="size-3 rounded-full bg-gray-600 dark:bg-gray-700 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"> </div>
                    </div>
                </div>
                <div class="flex items-center justify-center">
                    <div class="relative size-6 rounded-full bg-gray-600 rotate-90">
                      <div class="absolute left-1/2 top-1/2 w-0.5 h-3 bg-white rounded-sm -translate-x-1/2">
                      </div>
                    </div>
                </div>

            </div>
        </div>
    </section>

    <!-- EDIT PANEL -->
    
    @if(SelectedInput != null || SelectedOutput != null) {
        <section class="p-4 rounded-xl border bg-gray-50 border-gray-200 dark:bg-gray-900 dark:border-gray-700 space-y-4">

        @if (SelectedInput != null)
        {
            <div class="mb-2">
                <h3 class="text-md font-medium dark:text-gray-200">
                    Input CH @SelectedInput.Index
                </h3>
            </div>

            <div>
                <label class="block text-xs text-gray-700 dark:text-gray-300 mb-1">
                    Name & Icon
                </label>
            
                <div class="flex items-center gap-3">
            
                    <!-- ICON DROPDOWN BUTTON -->
                    <div class="relative">
            
                        <button @onclick="ToggleIconDropdown"
                                class="size-10 rounded-lg flex items-center justify-center cursor-pointer
                                       bg-white dark:bg-gray-800
                                       border border-gray-300 dark:border-gray-600
                                       transition">
            
                            @if (SelectedInput?.Icon.HasValue ?? false)
                            {
                                <i class="@SelectedInput.Icon.Map(i => i.ToString()).ValueOr("") fal text-lg"></i>
                            }
                            else
                            {
                                <span class="flex flex-col">
                                    <i class="fa-times fal text-xs text-gray-600"></i>
                                    <span class="text-[10px] leading-3 text-gray-500 dark:text-gray-400">none</span>
                                </span>
                            }
                        </button>
            
                        <!-- DROPDOWN PANEL -->
                        @if (IconDropdownOpen)
                        {
                            <div class="absolute left-0 mt-2 p-2 w-56 rounded-lg z-40
                                        bg-white dark:bg-gray-800
                                        border border-gray-300 dark:border-gray-700
                                        shadow-xl">
                                <div class="flex gap-1 flex-wrap">
                                      <div class="flex items-center bg-gray-50 p-2 cursor-pointer border border-gray-200 size-9 justify-center rounded"
                                           @onclick="() => SelectIconFromDropdown(null)">
                                          <i class="fa-times fal text-lg text-gray-600"></i>
                                      </div>
                                    <!-- ICON LIST -->
                                    @foreach (var icon in Icon.Enumerators)
                                    {
                                        <div class="flex items-center p-1.5 cursor-pointer border border-gray-200 size-9 justify-center rounded"
                                             @onclick="() => SelectIconFromDropdown(icon)">
                                            <i class="@icon.ToString() fal text-lg"></i>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
            
                    <!-- NAME INPUT -->
                    <input type="text"
                           value="@SelectedInput?.Name"
                           @oninput="OnInputNameChanged"
                           placeholder="Instrument name..." />
                </div>
            </div>


            <div>
                <label class="block text-xs text-gray-700 dark:text-gray-300">Color</label>

                <div class="flex items-center gap-2.5 mt-1">

                    <!-- No Color -->
                    <div class="flex flex-col items-center gap-1 cursor-pointer"
                         @onclick="() => SetColorForInput(null)">
                        <div class="
                            size-8 rounded-full border flex items-center justify-center
                            border-gray-400 dark:border-gray-500
                        ">
                            <span class="text-xs text-gray-500 dark:text-gray-300">×</span>
                        </div>
                        <span class="text-[10px] text-gray-500 dark:text-gray-300">None</span>
                    </div>

                    <!-- COLORS -->
                    @foreach (var c in Color.Enumerators)
                    {
                        var isSelected = SelectedInput?.Color?.MappedValue == c.MappedValue;

                        <div class="flex flex-col items-center gap-1 cursor-pointer"
                             @onclick="() => SetColorForInput(c)">
                            <div class="
                                w-8 h-8 rounded-full flex items-center justify-center transition border
                                border-gray-200 dark:border-gray-600
                                @(isSelected ? "border-primary-500 ring-2 ring-primary-500/50" : "")
                                dark:ring-offset-gray-900
                            "
                                 style="background-color:@c.HexOpaque">
                            </div>
                            <span class="text-[10px] text-gray-500 dark:text-gray-300">@c.ToString()</span>
                        </div>
                    }
                </div>
            </div>
            
            <div>
                <label class="block text-xs text-gray-700 dark:text-gray-300">Gain</label>
                
                <button class="mt-1 border border-dashed bg-gray-100 border-gray-200 dark:bg-gray-800 dark:border-gray-700 py-1 rounded-lg w-full text-gray-700 dark:text-gray-500 font-normal text-sm" @onclick="OpenGainModal">
                    Click to set gain
                </button>
            </div>
        }

        <!-- OUTPUT PANEL -->
        @if (SelectedOutput != null)
        {
            <h3 class="text-lg font-bold mb-3 text-gray-800 dark:text-gray-100">
                Output: @SelectedOutput.ShortLabel
            </h3>

            <div class="mb-4">
                <label class="block text-sm text-gray-600 dark:text-gray-300">Name</label>
                <input class=""
                       type="text"
                       @bind="SelectedOutput.Name"
                       placeholder="Person name..." />
            </div>
        }

    </section>
    }
    <!-- GAIN MODAL -->
    @if (ShowGainModal)
    {
        <div class="fixed inset-0 bg-black/60 flex justify-center items-center z-50">

            <div class="
                rounded-xl p-6 w-80 shadow-xl animate-fadein bg-white
                dark:bg-gray-800 dark:text-gray-100 dark:shadow-2xl
            ">
                <h2 class="text-lg font-semibold mb-4">
                    Gain — CH @SelectedInput?.Index
                </h2>

                <input type="range"
                       min="-12"
                       max="60"
                       value="@GainValue"
                       step="1"
                       @oninput="OnGainChanged"
                       class="w-full" />

                <p class="mt-2 text-center text-gray-700 dark:text-gray-300">
                    @GainValue
                </p>

                <div class="flex justify-end gap-2 mt-4">
                    <button class="btn" @onclick="CloseGainModal">Close</button>
                </div>
            </div>
        </div>
    }

</div>



@code {

    private SocketInfo? SelectedInput;
    private SocketInfo? SelectedOutput;
    private bool ShowGainModal = false;
    private DecibelGain GainValue = 0;
    private string NameValue = "";
    private bool IconDropdownOpen = false;
    
    void ToggleIconDropdown() => IconDropdownOpen = !IconDropdownOpen;
    void CloseIconDropdown() => IconDropdownOpen = false;

    async Task SelectIconFromDropdown(Icon? icon)
    {
        IconDropdownOpen = false;

        if (icon == null)
        {
            SelectedInput!.Icon = Option.None<Icon>();
            var encoded = BuildEncodedName(SelectedInput?.Name ?? "", SelectedInput!.Icon);
            await Mixer.Channel(SelectedInput!.Index).SetName(encoded);
            StateHasChanged();
            return;
        }

        await SetIcon(icon);
    }
    void SelectInput(Channel channel)
    {
        SelectedOutput = null;

        SelectedInput = new SocketInfo
        {
            Index = channel.Index,
            Name = channel.Name,
            Icon = channel.Icon,
            Color = channel.Color.Match(c => c, () => null),
        };

        GainValue = channel.Gain;
    }


    void SelectOutput(int busIndex)
    {
        SelectedInput = null;

        var busModel = Model.Busses.FirstOrDefault(b => b.Index == busIndex);

        SelectedOutput = new SocketInfo
        {
            Index = busIndex,
            Name = busModel?.Name ?? "",
            Color = busModel?.Color,
            ShortLabel = $"B{busIndex}"
        };
    }


    async Task SetColorForInput(Color? c)
    {
        if (SelectedInput == null) return;

        SelectedInput.Color = c;

        if (c is not null)
        {
            await Mixer.Channel(SelectedInput.Index).SetColor(c);
        }

        StateHasChanged();
    }



    void OpenGainModal()
    {
        ShowGainModal = true;
    }

    void CloseGainModal()
    {
        ShowGainModal = false;
    }

    async Task SetIcon(Icon icon)
    {
        if (SelectedInput == null)
            return;

        SelectedInput.Icon = icon.SomeNotNull();

        var encoded = BuildEncodedName(SelectedInput.Name ?? "", SelectedInput.Icon);

        await Mixer.Channel(SelectedInput.Index).SetName(encoded);

        StateHasChanged();
    }
    
    private static string BuildEncodedName(string name, Option<Icon> icon)
    {
        if (string.IsNullOrWhiteSpace(name))
            return "";

        name = name.Replace("_", ""); // underscore nooit toelaten

        return icon.Map(i => $"{name}_{i.MappedValue}").ValueOr(name);
    }

    async Task OnGainChanged(ChangeEventArgs e)
    {
        GainValue = Convert.ToSingle(e.Value); // dB
        if (SelectedInput != null)
        {
            await Mixer.Channel(SelectedInput.Index).SetGain(GainValue);
        }
    }
    
    async Task OnInputNameChanged(ChangeEventArgs e)
    {
        if (SelectedInput == null)
            return;

        var cleanName = (e.Value?.ToString() ?? "").Replace("_", "");

        SelectedInput.Name = cleanName;

        var encoded = BuildEncodedName(cleanName, SelectedInput.Icon);

        await Mixer.Channel(SelectedInput.Index).SetName(encoded);
    }

    private void SyncSelectedInput()
    {
        if (SelectedInput == null)
            return;

        var live = Model.Channels.FirstOrDefault(c => c.Index == SelectedInput.Index);
        if (live == null)
            return;

        SelectedInput.Name = live.Name;
        SelectedInput.Color = live.Color.Match(c => c, () => null);
        GainValue = live.Gain; 
    }

    protected override void OnInitialized()
    {
        Model.StateChanged += _ =>
        {
            SyncSelectedInput();
            InvokeAsync(StateHasChanged);
        };    
    }


    public class SocketInfo
    {
        public int Index { get; set; }
        public string? Name { get; set; }
        public Option<Icon> Icon { get; set; }
        public Color? Color { get; set; }
        public string ShortLabel { get; set; } = "";
    }
}

@attribute [Route(Routes.InOut)]
@using Eggbox.Models
@using Eggbox.Services
@using Color = Eggbox.Models.Color
@using Eggbox.Helpers
@using Optional
@using Icon = Eggbox.Models.Icon
@inject Mixer Mixer
@inject MixerModel Model
@inject NavigationManager Nav

<section class="h-full flex flex-col select-none">

    <div class="p-4 flex flex-col items-center">
        <h2 class="text-xl font-medium mb-4">
            Choose inputs / outputs
        </h2>

        <div class="
            relative p-4 rounded-xl border bg-gray-100 border-gray-300
            dark:bg-gray-900 dark:border-gray-700
        ">
            <!-- INPUTS -->
            <div class="grid grid-cols-8 gap-2">
                @foreach (var ch in Model.Channels)
                {
                    var isActive = SelectedInput?.Index == ch.Index;

                    <div class="
                        w-9 h-9 rounded-full border flex items-center justify-center cursor-pointer transition text-gray-950
                        border-gray-300 dark:border-gray-700
                        @(isActive ? "ring-2 ring-primary scale-110" : "hover:scale-110")
                    "
                         style="background-color:@(ch.Color.Match(c => c.HexOpaque, () => "transparent"))"
                         @onclick="() => SelectInput(ch)">
                        @ch.Index
                    </div>
                }
            </div>

            <!-- OUTPUTS -->
            <div class="flex gap-1 mt-4 justify-center">
                @foreach (var bus in Outputs)
                {
                    var isActive = SelectedOutput?.Index == bus.Index;

                    <div class="
                        w-9 h-9 rounded-tl-lg rounded-tr-4xl rounded-b-4xl border flex items-center justify-center cursor-pointer transition text-gray-900
                        border-gray-300 dark:border-gray-600
                        @(isActive ? "ring-2 ring-primary scale-110" : "hover:scale-110")
                    "
                         style="background-color:@bus.Color.HexOpaque"
                         @onclick="() => SelectOutput(bus.Index)">
                        @bus.Short
                    </div>
                }

                <div class="w-9 h-9 rounded-full bg-gray-400 dark:bg-gray-600"></div>
                <div class="w-9 h-9 rounded-full bg-gray-400 dark:bg-gray-600"></div>

            </div>
        </div>
    </div>

    <!-- EDIT PANEL -->
    <div class="border-t dark:border-gray-800 p-6">

        <!-- INPUT PANEL -->
        @if (SelectedInput != null)
        {
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-md font-medium text-gray-200">
                    Input CH @SelectedInput.Index
                </h3>
                <button class="btn btn-sm btn-primary" @onclick="OpenGainModal">
                    Adjust Gain
                </button>
            </div>

            <div class="mb-4">
                <label class="block text-xs text-gray-600 dark:text-gray-300">Name</label>
                <input class="
                        w-full border p-2 rounded
                        border-gray-300 bg-white text-gray-900
                        dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100
                    "
                       value="@SelectedInput.Name"
                       @oninput="OnInputNameChanged"
                       placeholder="Instrument name..." />
            </div>

            <div class="mb-4">
                <label class="block text-xs text-gray-600 dark:text-gray-300">Color</label>

                <div class="flex items-center gap-3 mt-1">

                    <!-- No Color -->
                    <div class="flex flex-col items-center gap-1 cursor-pointer"
                         @onclick="() => SetColorForInput(null)">
                        <div class="
                            w-8 h-8 rounded-full border flex items-center justify-center
                            border-gray-400 dark:border-gray-500
                        ">
                            <span class="text-xs text-gray-500 dark:text-gray-300">×</span>
                        </div>
                        <span class="text-[10px] text-gray-500 dark:text-gray-300">None</span>
                    </div>

                    <!-- COLORS -->
                    @foreach (var c in Color.Enumerators)
                    {
                        var isSelected = SelectedInput?.Color?.MappedValue == c.MappedValue;

                        <div class="flex flex-col items-center gap-1 cursor-pointer"
                             @onclick="() => SetColorForInput(c)">
                            <div class="
                                w-8 h-8 rounded-full flex items-center justify-center transition border
                                border-gray-200 dark:border-gray-600
                                @(isSelected ? "ring-2 ring-offset-2 ring-primary scale-110" : "hover:scale-110")
                                dark:ring-offset-gray-900
                            "
                                 style="background-color:@c.HexOpaque">
                            </div>
                            <span class="text-[10px] text-gray-500 dark:text-gray-300">@c.ToString()</span>
                        </div>
                    }
                </div>
            </div>
            
            <div>       
                <label class="block text-xs text-gray-600 dark:text-gray-300">Icon</label>
                <div class="flex gap-2 flex-wrap">

                    @foreach (var icon in Icon.Enumerators)
                    {
                        var isSel = SelectedInput?.Icon.Contains(icon) ?? false;

                        <div class="p-2 size-10 rounded cursor-pointer text-white transition border bg-gray-700 hover:bg-gray-300
                                        @(isSel ? "border-white" : "border-transparent")"
                             @onclick="() => SetIcon(icon)">
                            <i class="@icon.ToString() fad text-xl"></i>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- OUTPUT PANEL -->
        @if (SelectedOutput != null)
        {
            <h3 class="text-lg font-bold mb-3 text-gray-800 dark:text-gray-100">
                Output: @SelectedOutput.ShortLabel
            </h3>

            <div class="mb-4">
                <label class="block text-sm text-gray-600 dark:text-gray-300">Name</label>
                <input class="
                        w-full border p-2 rounded
                        border-gray-300 bg-white text-gray-900
                        dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100
                    "
                       @bind="SelectedOutput.Name"
                       placeholder="Person name..." />
            </div>
        }

    </div>

    <!-- GAIN MODAL -->
    @if (ShowGainModal)
    {
        <div class="fixed inset-0 bg-black/60 flex justify-center items-center z-50">

            <div class="
                rounded-xl p-6 w-80 shadow-xl animate-fadein bg-white
                dark:bg-gray-800 dark:text-gray-100 dark:shadow-2xl
            ">
                <h2 class="text-lg font-semibold mb-4">
                    Gain — CH @SelectedInput?.Index
                </h2>

                <input type="range"
                       min="-12"
                       max="60"
                       value="@GainValue"
                       step="1"
                       @oninput="OnGainChanged"
                       class="w-full" />

                <p class="mt-2 text-center text-gray-700 dark:text-gray-300">
                    @GainValue
                </p>

                <div class="flex justify-end gap-2 mt-4">
                    <button class="btn" @onclick="CloseGainModal">Close</button>
                </div>
            </div>
        </div>
    }

</section>



@code {

    private SocketInfo? SelectedInput;
    private SocketInfo? SelectedOutput;
    private bool ShowGainModal = false;
    private DecibelGain GainValue = 0;
    private string NameValue = "";
    
    private List<(int Index, string Short, Color Color)> Outputs => new()
    {
        (1, "B1", Color.Red),
        (2, "B2", Color.Green),
        (3, "B3", Color.Yellow),
        (4, "B4", Color.Blue),
        (11, "L", Color.Magenta),
        (12, "R", Color.White)
    };

    void SelectInput(Channel channel)
    {
        SelectedOutput = null;

        SelectedInput = new SocketInfo
        {
            Index = channel.Index,
            Name = channel.Name,
            Icon = channel.Icon,
            Color = channel.Color.Match(c => c, () => null),
        };

        GainValue = channel.Gain;
    }


    void SelectOutput(int bus)
    {
        SelectedInput = null;

        var def = Outputs.First(x => x.Index == bus);
        var busModel = Model.Busses.FirstOrDefault(b => b.Index == bus);

        SelectedOutput = new SocketInfo
        {
            Index = bus,
            Name = busModel?.Name ?? def.Short,
            Color = def.Color,
            ShortLabel = def.Short
        };
    }


    async Task SetColorForInput(Color? c)
    {
        if (SelectedInput == null) return;

        SelectedInput.Color = c;

        if (c is not null)
        {
            await Mixer.Channel(SelectedInput.Index).SetColor(c);
        }

        StateHasChanged();
    }



    void OpenGainModal()
    {
        ShowGainModal = true;
    }

    void CloseGainModal()
    {
        ShowGainModal = false;
    }

    async Task SetIcon(Icon icon)
    {
        if (SelectedInput == null)
            return;

        SelectedInput.Icon = icon.SomeNotNull();

        var encoded = BuildEncodedName(SelectedInput.Name ?? "", SelectedInput.Icon);

        await Mixer.Channel(SelectedInput.Index).SetName(encoded);

        StateHasChanged();
    }
    
    private static string BuildEncodedName(string name, Option<Icon> icon)
    {
        if (string.IsNullOrWhiteSpace(name))
            return "";

        name = name.Replace("_", ""); // underscore nooit toelaten

        return icon.Map(i => $"{name}_{i.MappedValue}").ValueOr(name);
    }

    async Task OnGainChanged(ChangeEventArgs e)
    {
        GainValue = Convert.ToSingle(e.Value); // dB
        if (SelectedInput != null)
        {
            await Mixer.Channel(SelectedInput.Index).SetGain(GainValue);
        }
    }
    
    async Task OnInputNameChanged(ChangeEventArgs e)
    {
        if (SelectedInput == null)
            return;

        var cleanName = (e.Value?.ToString() ?? "").Replace("_", "");

        SelectedInput.Name = cleanName;

        var encoded = BuildEncodedName(cleanName, SelectedInput.Icon);

        await Mixer.Channel(SelectedInput.Index).SetName(encoded);
    }

    private void SyncSelectedInput()
    {
        if (SelectedInput == null)
            return;

        var live = Model.Channels.FirstOrDefault(c => c.Index == SelectedInput.Index);
        if (live == null)
            return;

        SelectedInput.Name = live.Name;
        SelectedInput.Color = live.Color.Match(c => c, () => null);
        GainValue = live.Gain; 
    }

    protected override void OnInitialized()
    {
        Model.StateChanged += _ =>
        {
            SyncSelectedInput();
            InvokeAsync(StateHasChanged);
        };    
    }


    public class SocketInfo
    {
        public int Index { get; set; }
        public string? Name { get; set; }
        public Option<Icon> Icon { get; set; }
        public Color? Color { get; set; }
        public string ShortLabel { get; set; } = "";
    }
}

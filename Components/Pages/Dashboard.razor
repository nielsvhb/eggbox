@attribute [Route(Routes.Dashboard)]
@using Eggbox.Services
@using Eggbox.Models
@using Optional
@using Color = Eggbox.Models.Color
@using Eggbox.Helpers

@inject Mixer Mixer
@inject MixerModel Model
@inject NavigationManager Nav

<PageTitle>Dashboard</PageTitle>

<div class="p-4 space-y-4">
    <style>
        .fader-vertical {
            writing-mode: bt-lr;
            -webkit-appearance: slider-vertical;
            height: 180px;
            width: 28px;
        }

        .fader-card {
            transition: background 0.2s ease, transform 0.1s ease;
        }

        .fader-card:hover {
            background: rgba(255, 255, 255, 0.85);
            transform: scale(1.02);
        }
    </style>

    <div class="flex justify-between items-center">
        <div class="flex items-center gap-2">
            <select @bind="_selectedOutput">
                <option value="0">Main LR</option>

                @foreach (var b in Model.Busses)
                {
                    <option value="@b.Index">Bus @b.Index (@b.Name)</option>
                }
            </select>
        </div>
    </div>

    @if (_loading)
    {
        <div class="text-neutral-500 text-sm mt-3">Loading...</div>
    }
    else if (_channels.Any())
    {
        <div class="grid gap-2 grid-cols-8 mt-3">
            @foreach (var ch in _channels)
            {
                <div class="rounded-lg border p-2 text-center bg-white/60 backdrop-blur fader-card">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-medium text-[9xs]">@ch.Name</span>

                        <input type="checkbox"
                               checked="@ch.Muted"
                               @onchange="(e) => ToggleMute(ch, (bool)e.Value!)"
                               title="Mute channel" />
                    </div>

                    <input type="range"
                           min="0" max="1" step="0.01"
                           value="@ch.Fader"
                           class="fader-vertical"
                           @oninput="(e) => OnFaderChanged(ch, Convert.ToSingle(e.Value))" />

                    <div class="text-xs mt-1 text-center">@((int)(ch.Fader * 100))%</div>

                    <div class="w-full h-1.5 mt-2 rounded-full"
                         style="background:@ch.Color.Map(c => c.HexCode)"></div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="text-neutral-500 text-sm mt-3">No channels loaded</div>
    }
</div>

@code {
    private bool _loading = true;
    private int _selectedOutput = 0; // 0 = Main LR
    private List<ChannelVm> _channels = new();

    protected override void OnInitialized()
    {
        Model.StateChanged += _ =>
        {
            BuildVm();
            InvokeAsync(StateHasChanged);
        };

        BuildVm();
        _loading = false;
    }

    private void BuildVm()
    {
        _channels = Model.Channels.Select(ch =>
        {
            var fader = _selectedOutput == 0
                ? ch.Fader            
                : ch.Sends.TryGetValue(_selectedOutput, out var s) ? s.Level : 0f;

            var mute = _selectedOutput == 0
                ? ch.Mute
                : ch.Sends.TryGetValue(_selectedOutput, out var s2) && s2.Mute;

            return new ChannelVm
            {
                Index = ch.Index,
                Name = ch.Name,
                Fader = fader,
                Muted = mute,
                Color = ch.Color
            };
        }).ToList();
    }

    private async Task OnFaderChanged(ChannelVm vm, float value)
    {
        vm.Fader = value;

        if (_selectedOutput == 0)
            await Mixer.Channel(vm.Index).SetFader(value);
        else
            await Mixer.Channel(vm.Index).SetSendLevel(_selectedOutput, value);
    }

    private async Task ToggleMute(ChannelVm vm, bool muted)
    {
        vm.Muted = muted;

        if (_selectedOutput == 0)
            await Mixer.Channel(vm.Index).SetMute(muted);
        else
            await Mixer.Channel(vm.Index).SetSendMute(_selectedOutput, muted);
    }

    private sealed class ChannelVm
    {
        public int Index { get; set; }
        public string Name { get; set; } = "";
        public DecibelFader Fader { get; set; }
        public bool Muted { get; set; }
        public Option<Color> Color { get; set; }
    }
}

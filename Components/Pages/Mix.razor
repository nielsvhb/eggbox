@attribute [Route(Routes.Mix)]
@using Eggbox.Services
@using Eggbox.Models
@using Optional
@using Color = Eggbox.Models.Color
@using Eggbox.Helpers
@using Optional.Collections

@inject Mixer Mixer
@inject MixerModel Model
@inject NavigationManager Nav

<PageTitle>Mix</PageTitle>

<div class="p-4">
    <style>
        .scrollbar-custom {
            scrollbar-width: thin;
            scrollbar-color: #a7adb6 transparent;
        }
            
    </style>

    <div class="">
        <label for="" class="text-xs font-medium text-gray-500">Select mix</label>
        <div class="flex items-center gap-2">
           <div class="w-3 h-3 rounded-full"
                style="background-color:@Model.Busses.FirstOrNone(b => b.Index == SelectedOutput).Map(b => b.Color.HexOpaque).ValueOr("#ccc")"></div>
       
           <select @bind="SelectedOutput"
                   class="px-3 py-1.5 rounded border border-gray-300 bg-white shadow-sm text-sm">
               <option value="0">Main LR</option>
               @foreach (var b in Model.Busses)
               {
                   <option value="@b.Index">@b.Name</option>
               }
           </select>
       </div>

    </div>

    @if (_loading)
    {
        <div class="text-center">
            <LoadingSpinner></LoadingSpinner>
        </div>
    }
    else if (_channels.Any())
    {
        <div class="max-w-[1920px] mx-auto overflow-x-auto scrollbar-custom mt-3">
            <div class="flex gap-1 min-w-max">
                @foreach (var ch in _channels)
                {
                    <article class="flex flex-col items-center gap-1 p-1 rounded border border-gray-200 bg-gray-50 hover:border-gray-300 transition-colors">
                        <button class="w-full relative group">
                            <div class="transition-opacity group-hover:opacity-90 mx-auto">
                                <div class="w-9 h-9 rounded flex items-center justify-center border" style="border-color: @ch.Color.Map(c => c.HexOpaque).ValueOr("#ccc"); background-color: @ch.Color.Map(c => c.HexTransparent).ValueOr("#ccc");">
                                    <i class="fad fa-microphone text-gray-500"></i>
                                </div>
                            </div>
                        </button>
                        <div class="text-[9px] text-gray-600">CH @ch.Index.ToString("D2")</div>
                        <div class="text-[8px] text-gray-800 text-center px-1 leading-tight max-w-[40px] font-semibold line-clamp-2 h-[20px] flex items-center justify-center">@ch.Name</div>
                       <Fader Value="ch.Fader"
                              ValueChanged="(f) => OnFaderChanged(ch, f)" />
                        
                        <div class="text-[10px] text-gray-700 mt-2 mb-1">@ch.Fader.ToString()</div>
    
                        <button @onclick="() => ToggleMute(ch, !ch.Muted)"
                                class="
                                    w-full px-1 py-1.5 rounded transition
                                    flex items-center justify-center
                                    border
                        
                                    @(ch.Muted
                                        ? "bg-primary/30 border-primary text-primary hover:bg-primary/40"
                                        : "bg-gray-200 border-gray-300 text-gray-600 hover:bg-gray-300")
                                ">
                            <i class="@(ch.Muted ? "fad fa-volume-xmark" : "fad fa-volume-high")"></i>
                        </button>

                    </article>
                }
            </div>
        </div>
    }
    else
    {
        <div class="text-neutral-500 text-sm mt-3">No channels loaded</div>
    }
</div>

@code {
    private bool _loading = true;
    private int _selectedOutput = 0; // 0 = Main LR
    private List<ChannelVm> _channels = new();

    private int SelectedOutput
    {
        get => _selectedOutput;
        set
        {
            if (_selectedOutput != value)
            {
                _selectedOutput = value;
                BuildVm();             
                InvokeAsync(StateHasChanged);
            }
        }
    }

    protected override void OnInitialized()
    {
        Model.StateChanged += _ =>
        {
            BuildVm();
            InvokeAsync(StateHasChanged);
        };

        BuildVm();
        _loading = false;
    }

    private void BuildVm()
    {
        _channels = Model.Channels.Select(ch =>
        {
            var fader = _selectedOutput == 0
                ? ch.MainFader            
                : ch.Sends.TryGetValue(_selectedOutput, out var s) ? s.Level : 0d;

            var mute = _selectedOutput == 0
                ? ch.MainMute
                : ch.Sends.TryGetValue(_selectedOutput, out var s2) && s2.Mute;

            return new ChannelVm
            {
                Index = ch.Index,
                Name = ch.Name,
                Fader = fader,
                Muted = mute,
                Color = ch.Color
            };
        }).ToList();
    }

    private async Task OnFaderChanged(ChannelVm vm, DecibelFader f)
    {
        vm.Fader = f;
        
        if (_selectedOutput == 0)
            await Mixer.Channel(vm.Index).SetFader(f);
        else
            await Mixer.Channel(vm.Index).SetSendLevel(_selectedOutput, f);
    }


    private async Task ToggleMute(ChannelVm vm, bool muted)
    {
        vm.Muted = muted;

        if (_selectedOutput == 0)
            await Mixer.Channel(vm.Index).SetMute(muted);
        else
            await Mixer.Channel(vm.Index).SetSendMute(_selectedOutput, muted);
    }

    private sealed class ChannelVm
    {
        public int Index { get; set; }
        public string Name { get; set; } = "";
        public DecibelFader Fader { get; set; }
        public bool Muted { get; set; }
        public Option<Color> Color { get; set; }
    }
}

@attribute [Route(Routes.Layout)]
@using Eggbox.Models
@using Eggbox.Services
@inject Mixer Mixer
@inject MixerModel Model
@inject NavigationManager Nav

<section class="h-full flex flex-col">
    <div class="p-3 flex flex-col items-center">
        <h2 class="text-xl font-semibold mb-4 text-gray-700">Choose inputs/outputs</h2>
        <div class="relative p-3 border border-gray-300 rounded-xl bg-gray-100">
            <div class="grid grid-cols-8 gap-2">
                @foreach(var channel in Model.Channels) {
                    <div class="w-9 h-9 rounded-full border flex items-center justify-center
                                cursor-pointer hover:scale-110 transition"
                         style="background-color:@(channel.Color.Match(
                             some: c => c.HexCode,
                             none: () => "transparent"
                         ))"
                         @onclick="() => SelectInput(channel)">
                        @channel.Index
                    </div>
                }
            </div>

            <div class="flex gap-1 mt-4 justify-center">
                @foreach (var bus in Outputs)
                {
                    <div class="w-9 h-9 rounded-full rounded-tl border border-gray-500 flex items-center justify-center cursor-pointer
                                hover:bg-gray-200 transition"
                         style="background-color:@bus.Color.HexCode"
                         @onclick="() => SelectOutput(bus.Index)">
                        @bus.Short
                    </div>
                }
                <div class="w-9 h-9 rounded-full bg-gray-400"></div> 
                <div class="w-9 h-9 rounded-full bg-gray-400"></div> 
            </div>
        </div>
    </div>


    <div class="border-t border-gray-300 p-6 bg-white shadow-inner">
        @if (SelectedInput != null)
        {
            <h3 class="text-lg font-bold mb-3">Input CH@SelectedInput.Index</h3>

            <div class="mb-4">
                <label class="block text-sm text-gray-600">Name</label>
                <input class="w-full border border-gray-300 p-2 rounded"
                       @bind="SelectedInput.Name" placeholder="Instrument name..." />
            </div>

            <div class="mb-4">
                <label class="block text-sm text-gray-600">Assigned Output Color</label>
                <div class="flex gap-4 mt-2">
                    @foreach (var c in Colors)
                    {
                        <div class="w-8 h-8 rounded-full border cursor-pointer hover:scale-110 transition"
                             style="background-color:@c.HexCode"
                             @onclick="() => SetColorForInput(c)">
                        </div>
                    }
                </div>
            </div>

            <button class="btn btn-secondary mt-4"
                    @onclick="OpenGainModal">
                Adjust Gain
            </button>
        }

        @if (SelectedOutput != null)
        {
            <h3 class="text-lg font-bold mb-3">Output: @SelectedOutput.ShortLabel</h3>

            <div class="mb-4">
                <label class="block text-sm text-gray-600">Name</label>
                <input class="w-full border border-gray-300 p-2 rounded"
                       @bind="SelectedOutput.Name" placeholder="Person name..." />
            </div>
        }
    </div>

</section>


@code {
    private SocketInfo? SelectedInput;
    private SocketInfo? SelectedOutput;

    private List<MixerColor> Colors = new()
    {
        MixerColor.Red,
        MixerColor.Green,
        MixerColor.Yellow,
        MixerColor.Blue,
        MixerColor.Magenta
    };

    private List<(int Index, string Short, MixerColor Color)> Outputs => new()
    {
        (1, "B1", MixerColor.Red),
        (2, "B2", MixerColor.Green),
        (3, "B3", MixerColor.Yellow),
        (4, "B4", MixerColor.Blue),
        (11, "L", MixerColor.Magenta), // main L
        (12, "R", MixerColor.White)  // main R
    };

    void SelectInput(Channel channel)
    {
        SelectedOutput = null;
        SelectedInput = new SocketInfo
        {
            Index = channel.Index,
            Name = channel.Name ?? ""
        };
    }

    void SelectOutput(int bus)
    {
        var (i, shortName, color) = Outputs.First(x => x.Index == bus);

        SelectedInput = null;
        SelectedOutput = new SocketInfo
        {
            Index = i,
            Name = Model.Busses.FirstOrDefault(b => b.Index == i)?.Name ?? shortName,
            Color = color,
            ShortLabel = shortName
        };
    }

    async Task SetColorForInput(MixerColor c)
    {
        if (SelectedInput == null) return;

        SelectedInput.Color = c;

        await Mixer.Channel(SelectedInput.Index).SetColor(c);

        StateHasChanged();
    }

    void OpenGainModal()
    {
        // modal logica hier
    }
    
    protected override async Task OnInitializedAsync()
    {
        Model.StateChanged += key => InvokeAsync(StateHasChanged);
    }

    public class SocketInfo
    {
        public int Index { get; set; }
        public string? Name { get; set; }
        public MixerColor Color { get; set; } = MixerColor.Red;
        public string ShortLabel { get; set; } = "";
    }
}

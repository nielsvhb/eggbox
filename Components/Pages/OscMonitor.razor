@attribute [Route(Routes.OscMonitor)]
@using Eggbox.Services
@using Eggbox.Models
@inject UDPService IO
@inject TrafficLogger Traffic

<section class="p-6 select-none">

    <h2 class="text-2xl font-bold mb-4 text-gray-700">OSC Monitor</h2>

    <div class="flex gap-2 mb-4">
        <input @bind="command"
               placeholder="/ch/01/mix/fader 0.75"
               class="border border-gray-200 w-full" />

        <button @onclick="SendCommand" class="btn btn-primary">
            Send
        </button>
    </div>

    <!-- LOG VIEWER -->
    <div class="border rounded-lg bg-white shadow-inner p-3 text-xs font-mono overflow-y-auto"style="max-height: 480px;">

        @foreach (var entry in Traffic.Log.Reverse())
        {
            var color = entry.IsTx
                ? "#2b90d9"        
                : (entry.Handled 
                    ? "#2ecc71"  
                    : "#e74c3c");  

            var label = entry.IsTx ? "TX" : "RX";

            <div class="flex gap-2 py-0.5 px-0.5 rounded mb-1 whitespace-nowrap flex-nowrap"
                 style="background-color: @color20(color); color: black;">
                <span class="opacity-60">@entry.Timestamp.ToString("HH:mm:ss.fff")</span>
                <span class="font-bold">@label</span>
                <span>@entry.Address</span>
                <span class="opacity-70">@FormatArgs(entry.Arguments)</span>
            </div>
        }
    </div>

</section>

@code {

    private string command = "";

    private async Task SendCommand()
    {
        if (string.IsNullOrWhiteSpace(command)) return;

        var parts = command.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        var address = parts[0];
        var argStrings = parts.Skip(1).ToArray();

        object[] oscArgs = argStrings.Select(ParseArgument).ToArray();
        
        await IO.SendMessage(address, oscArgs);

        command = "";
    }

    private object ParseArgument(string raw)
    {
        if (int.TryParse(raw, out var i)) return i;

        if (float.TryParse(raw,
            System.Globalization.NumberStyles.Any,
            System.Globalization.CultureInfo.InvariantCulture,
            out var f))
            return f;

        return raw;
    }

    private string FormatArgs(IEnumerable<object?> args)
        => string.Join(" ", args.Select(a => a?.ToString() ?? ""));

    private string color20(string hex)
        => hex + "20"; // 20 = ~12% opacity
}

@using Eggbox.Helpers
@using System.Globalization
@inject IJSRuntime JS

<div class="relative flex items-start gap-1 select-none my-1">
    <div class="relative h-[350px] w-4 text-[8px] text-gray-500 dark:text-gray-400 text-right pr-1">
     @foreach (var mark in Marks)
     {
         <div class="absolute right-0 translate-y-1/2"
              style="bottom:@mark.Position%">
             @mark.Label
         </div>
     }
    </div>

    <div class="fader-root relative h-[350px] w-4" @ref="_rootRef">

        <!-- TRACK -->
        <div class="absolute left-1/2 -translate-x-1/2 w-[4px] h-full bg-gray-950 rounded-full"></div>

        <!-- RANGE -->
        <div class="fader-range absolute left-1/2 -translate-x-1/2 w-[4px] bg-primary rounded-full"
             style="height:@RangeHeightPercent%; bottom:0"></div>

        <!-- THUMB -->
        <div class="fader-thumb absolute left-1/2 -translate-x-1/2 w-[12px] h-[12px] 
                    bg-black border-2 border-primary rounded-full shadow 
                    translate-y-1/2"
             style="bottom:@ThumbBottomPercent%">
        </div>

    </div>
</div>

@code {
    [Parameter] public DecibelFader Value { get; set; }
    [Parameter] public EventCallback<DecibelFader> ValueChanged { get; set; }

    private ElementReference _rootRef;

    private readonly TimeSpan _throttleInterval = TimeSpan.FromMilliseconds(50); // 20 Hz
    private DateTime _lastCallbackTime = DateTime.MinValue;
    private DecibelFader? _pendingValue;
    private CancellationTokenSource? _flushCts;

    private double Linear => Value.ToLinear();
    private string ThumbBottomPercent =>
        (Linear * 100).ToString("0.###", CultureInfo.InvariantCulture);

    private string RangeHeightPercent =>
        (Linear * 100).ToString("0.###", CultureInfo.InvariantCulture);

    private record Mark(string Label, double Db);

    private Mark[] DbMarks = new[]
    {
        new Mark("+10",  10),
        new Mark("+5",    5),
        new Mark("0",     0),
        new Mark("-5",   -5),
        new Mark("-10", -10),
        new Mark("-20", -20),
        new Mark("-30", -30),
        new Mark("-50", -50),
        new Mark("-∞",  -90),
    };
    
    private IEnumerable<(string Label, string Position)> Marks =>
        DbMarks.Select(m =>
        {
            var linear = new DecibelFader(m.Db).ToLinear();
            var percent = (linear * 100).ToString("0.##", CultureInfo.InvariantCulture);
            return (m.Label, percent);
        });

    [JSInvokable]
    public async Task OnDrag(double percent)
    {
        var linear = percent / 100.0;
        var newFader = DecibelFader.FromLinear(linear);

        Value = newFader;
        StateHasChanged();

        await ThrottledCallback(newFader);
    }

    private async Task ThrottledCallback(DecibelFader f)
    {
        var now = DateTime.UtcNow;

        if (now - _lastCallbackTime < _throttleInterval)
        {
            _pendingValue = f;
            await ScheduleFinalFlush(f);
            return;
        }

        _lastCallbackTime = now;
        _pendingValue = null;

        await ValueChanged.InvokeAsync(f);

        await ScheduleFinalFlush(f);
    }

    private async Task ScheduleFinalFlush(DecibelFader finalValue)
    {
        _flushCts?.Cancel();
        _flushCts = new CancellationTokenSource();

        try
        {
            await Task.Delay(120, _flushCts.Token); // user probably stopped moving

            // send pending buffered value
            await ValueChanged.InvokeAsync(_pendingValue ?? finalValue);

        }
        catch { }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("fader.init", _rootRef, DotNetObjectReference.Create(this));
        }
    }
}
